name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write  # Required for Cosign signing and SLSA
  packages: write

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux builds
          - goos: linux
            goarch: amd64
            binary: diffusion-linux-amd64
            archive_type: tar.gz
          - goos: linux
            goarch: arm64
            binary: diffusion-linux-arm64
            archive_type: tar.gz
          - goos: linux
            goarch: arm
            goarm: 7
            binary: diffusion-linux-arm
            archive_type: tar.gz
          # macOS builds
          - goos: darwin
            goarch: amd64
            binary: diffusion-darwin-amd64
            archive_type: tar.gz
          - goos: darwin
            goarch: arm64
            binary: diffusion-darwin-arm64
            archive_type: tar.gz
          # Windows builds
          - goos: windows
            goarch: amd64
            binary: diffusion-windows-amd64.exe
            archive_type: zip
          - goos: windows
            goarch: arm64
            binary: diffusion-windows-arm64.exe
            archive_type: zip
          - goos: windows
            goarch: arm
            goarm: 7
            binary: diffusion-windows-arm.exe
            archive_type: zip
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if tag is on main branch
        run: |
          git fetch origin main
          if ! git merge-base --is-ancestor ${{ github.sha }} origin/main; then
            echo "Error: Tag must be created from main branch"
            exit 1
          fi
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"
      
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          mkdir -p bin
          go build -ldflags "-s -w -X main.Version=${{ steps.version.outputs.version }}" -o bin/${{ matrix.binary }} .
          echo "Built: bin/${{ matrix.binary }}"
      
      - name: Create archive
        run: |
          cd bin
          if [ "${{ matrix.archive_type }}" = "tar.gz" ]; then
            ARCHIVE_NAME="${{ matrix.binary }}.tar.gz"
            tar -czf "$ARCHIVE_NAME" "${{ matrix.binary }}"
            echo "Created: $ARCHIVE_NAME"
          else
            ARCHIVE_NAME="${{ matrix.binary }}.zip"
            zip "$ARCHIVE_NAME" "${{ matrix.binary }}"
            echo "Created: $ARCHIVE_NAME"
          fi
          # Remove the binary, keep only the archive
          rm "${{ matrix.binary }}"
      
      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}-archive
          path: bin/*
          retention-days: 1
  
  combine-hashes:
    name: Combine artifact hashes
    needs: [build]
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hashes.outputs.hashes }}
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Generate combined hashes
        id: hashes
        run: |
          cd bin
          # Generate hashes for all archives using find to avoid glob issues
          archives=$(find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) 2>/dev/null)
          
          if [ -z "$archives" ]; then
            echo "Error: No archive files found"
            exit 1
          fi
          
          # Generate and encode hashes
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec sha256sum {} \; | base64 -w0 > combined-hashes.txt
          echo "hashes=$(cat combined-hashes.txt)" >> "$GITHUB_OUTPUT"
          
          echo "Generated hashes:"
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec sha256sum {} \;
  
  checksums:
    name: Generate Checksums
    needs: [combine-hashes]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Generate checksums
        run: |
          cd bin
          # Generate checksums using find to avoid glob issues
          archives=$(find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) 2>/dev/null)
          
          if [ -z "$archives" ]; then
            echo "Error: No archive files found"
            exit 1
          fi
          
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec sha256sum {} \; | tee SHA256SUMS
          echo "Checksums generated:"
          cat SHA256SUMS
      
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: SHA256SUMS
          path: bin/SHA256SUMS
          retention-days: 1

  sign:
    name: Sign Archives with Cosign
    needs: [combine-hashes]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Sign archives with Cosign (keyless)
        run: |
          cd bin
          # Find all archives using find to avoid glob issues
          archives=$(find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) 2>/dev/null)
          
          if [ -z "$archives" ]; then
            echo "Error: No archive files found"
            exit 1
          fi
          
          # Sign all archives
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) | while IFS= read -r file; do
            echo "Signing $file..."
            cosign sign-blob --yes "$file" --output-signature "${file}.sig" --output-certificate "${file}.pem"
          done
      
      - name: Upload signatures
        uses: actions/upload-artifact@v4
        with:
          name: signatures
          path: |
            bin/*.sig
            bin/*.pem
          retention-days: 1

  provenance:
    name: Generate SLSA Provenance
    needs: [combine-hashes]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.combine-hashes.outputs.hashes }}"
      upload-assets: true
      provenance-name: "multiple.intoto.jsonl"

  release:
    name: Create GitHub Release
    needs: [combine-hashes, checksums, sign, provenance]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Create release notes
        id: notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cat > release-notes.md << 'EOF'
          ## Diffusion $VERSION
          
          ### Installation
          
          Download the appropriate archive for your platform and extract it:
          
          **Linux:**
          - AMD64: `diffusion-linux-amd64.tar.gz`
          - ARM64: `diffusion-linux-arm64.tar.gz`
          - ARM: `diffusion-linux-arm.tar.gz`
          
          **macOS:**
          - Intel: `diffusion-darwin-amd64.tar.gz`
          - Apple Silicon: `diffusion-darwin-arm64.tar.gz`
          
          **Windows:**
          - AMD64: `diffusion-windows-amd64.exe.zip`
          - ARM64: `diffusion-windows-arm64.exe.zip`
          - ARM: `diffusion-windows-arm.exe.zip`
          
          ### Extraction
          
          **Linux/macOS:**
          ```bash
          tar -xzf diffusion-linux-amd64.tar.gz
          chmod +x diffusion-linux-amd64
          ```
          
          **Windows:**
          ```powershell
          Expand-Archive diffusion-windows-amd64.exe.zip
          ```
          
          ### Verification
          
          All archives are signed with **Cosign** and have **SLSA Level 3 provenance** for supply chain security.
          
          **Verify checksums:**
          ```bash
          sha256sum --check SHA256SUMS --ignore-missing
          ```
          
          **Verify Cosign signature:**
          ```bash
          # Install cosign from https://github.com/sigstore/cosign
          cosign verify-blob \
            --certificate diffusion-linux-amd64.tar.gz.pem \
            --signature diffusion-linux-amd64.tar.gz.sig \
            --certificate-identity-regexp="https://github.com/Polar-Team/diffusion" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            diffusion-linux-amd64.tar.gz
          ```
          
          **Verify SLSA Provenance:**
          ```bash
          # Install slsa-verifier from https://github.com/slsa-framework/slsa-verifier
          slsa-verifier verify-artifact diffusion-linux-amd64.tar.gz \
            --provenance-path multiple.intoto.jsonl \
            --source-uri github.com/Polar-Team/diffusion \
            --source-tag v$VERSION
          ```
          
          ### What's Changed
          
          See [CHANGELOG](https://github.com/Polar-Team/diffusion/blob/main/docs/changelog.md) for details.
          
          ### Documentation
          
          - [Installation Guide](https://github.com/Polar-Team/diffusion#-installation)
          - [Building from Source](https://github.com/Polar-Team/diffusion/blob/main/docs/building.md)
          - [Verification Guide](https://github.com/Polar-Team/diffusion/blob/main/docs/verification.md)
          
          ---
          
          **Full Changelog**: https://github.com/Polar-Team/diffusion/compare/v$PREVIOUS_VERSION...v$VERSION
          EOF
          
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/*.tar.gz
            bin/*.zip
            bin/*.sig
            bin/*.pem
            bin/SHA256SUMS
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          {
            echo "## Release Created Successfully! ðŸŽ‰"
            echo ""
            echo "**Version:** ${GITHUB_REF#refs/tags/v}"
            echo "**Archives:** $(find bin/ -type f \( -name '*.tar.gz' -o -name '*.zip' \) | wc -l)"
            echo "**Signatures:** $(find bin/ -type f -name '*.sig' | wc -l)"
            echo "**Signing:** âœ“ Cosign (keyless)"
            echo "**Provenance:** âœ“ SLSA Level 3 (uploaded separately by provenance job)"
            echo ""
            echo "### Files Released:"
            echo '```'
            find bin/ -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.sig' -o -name '*.pem' -o -name 'SHA256SUMS' \) -exec ls -lh {} \;
            echo '```'
            echo ""
            echo "**Note:** SLSA provenance (multiple.intoto.jsonl) is uploaded directly by the provenance job."
          } >> "$GITHUB_STEP_SUMMARY"
