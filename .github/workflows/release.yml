name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write  # Required for Cosign signing
  packages: write

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux builds
          - goos: linux
            goarch: amd64
            binary: diffusion-linux-amd64
          - goos: linux
            goarch: arm64
            binary: diffusion-linux-arm64
          - goos: linux
            goarch: arm
            goarm: 7
            binary: diffusion-linux-arm
          # macOS builds
          - goos: darwin
            goarch: amd64
            binary: diffusion-darwin-amd64
          - goos: darwin
            goarch: arm64
            binary: diffusion-darwin-arm64
          # Windows builds
          - goos: windows
            goarch: amd64
            binary: diffusion-windows-amd64.exe
          - goos: windows
            goarch: arm64
            binary: diffusion-windows-arm64.exe
          - goos: windows
            goarch: arm
            goarm: 7
            binary: diffusion-windows-arm.exe
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if tag is on main branch
        run: |
          git fetch origin main
          if ! git merge-base --is-ancestor ${{ github.sha }} origin/main; then
            echo "Error: Tag must be created from main branch"
            exit 1
          fi
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          mkdir -p bin
          go build -ldflags "-s -w -X main.Version=${{ steps.version.outputs.version }}" -o bin/${{ matrix.binary }} .
          echo "Built: bin/${{ matrix.binary }}"
      
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: bin/${{ matrix.binary }}
          retention-days: 1

  checksums:
    name: Generate Checksums
    needs: [build]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Generate checksums
        run: |
          cd bin
          sha256sum * > SHA256SUMS
          echo "Checksums generated:"
          cat SHA256SUMS
      
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: SHA256SUMS
          path: bin/SHA256SUMS
          retention-days: 1

  sign:
    name: Sign Binaries with Cosign
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Sign binaries with Cosign (keyless)
        run: |
          cd bin
          for file in diffusion-*; do
            if [[ -f "$file" ]]; then
              echo "Signing $file..."
              cosign sign-blob --yes "$file" --output-signature "${file}.sig" --output-certificate "${file}.pem"
            fi
          done
      
      - name: Upload signatures
        uses: actions/upload-artifact@v4
        with:
          name: signatures
          path: |
            bin/*.sig
            bin/*.pem
          retention-days: 1

  release:
    name: Create GitHub Release
    needs: [build, checksums, sign]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true
      
      - name: Create release notes
        id: notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cat > release-notes.md << 'EOF'
          ## Diffusion $VERSION
          
          ### Installation
          
          Download the appropriate binary for your platform:
          
          **Linux:**
          - AMD64: `diffusion-linux-amd64`
          - ARM64: `diffusion-linux-arm64`
          - ARM: `diffusion-linux-arm`
          
          **macOS:**
          - Intel: `diffusion-darwin-amd64`
          - Apple Silicon: `diffusion-darwin-arm64`
          
          **Windows:**
          - AMD64: `diffusion-windows-amd64.exe`
          - ARM64: `diffusion-windows-arm64.exe`
          - ARM: `diffusion-windows-arm.exe`
          
          ### Verification
          
          All binaries are signed with Cosign for authenticity verification.
          
          **Verify checksums:**
          ```bash
          sha256sum --check SHA256SUMS --ignore-missing
          ```
          
          **Verify Cosign signature:**
          ```bash
          cosign verify-blob \
            --certificate diffusion-linux-amd64.pem \
            --signature diffusion-linux-amd64.sig \
            --certificate-identity-regexp="https://github.com/Polar-Team/diffusion" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            diffusion-linux-amd64
          ```
          
          ### What's Changed
          
          See [CHANGELOG](https://github.com/Polar-Team/diffusion/blob/main/docs/changelog.md) for details.
          
          ### Documentation
          
          - [Installation Guide](https://github.com/Polar-Team/diffusion#-installation)
          - [Building from Source](https://github.com/Polar-Team/diffusion/blob/main/docs/building.md)
          - [Verification Guide](https://github.com/Polar-Team/diffusion/blob/main/docs/verification.md)
          
          ---
          
          **Full Changelog**: https://github.com/Polar-Team/diffusion/compare/v$PREVIOUS_VERSION...v$VERSION
          EOF
          
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: bin/*
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## Release Created Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${GITHUB_REF#refs/tags/v}" >> $GITHUB_STEP_SUMMARY
          echo "**Binaries:** $(ls bin/ | grep -v '\.(sig|pem|SHA256SUMS)' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Signatures:** $(ls bin/*.sig | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Signing:** âœ“ Cosign (keyless)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Released:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh bin/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
