name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write  # Required for Cosign signing and SLSA
  packages: write

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux builds
          - goos: linux
            goarch: amd64
            binary: diffusion-linux-amd64
            archive_type: tar.gz
          - goos: linux
            goarch: arm64
            binary: diffusion-linux-arm64
            archive_type: tar.gz
          - goos: linux
            goarch: arm
            goarm: 7
            binary: diffusion-linux-arm
            archive_type: tar.gz
          # macOS builds
          - goos: darwin
            goarch: amd64
            binary: diffusion-darwin-amd64
            archive_type: tar.gz
          - goos: darwin
            goarch: arm64
            binary: diffusion-darwin-arm64
            archive_type: tar.gz
          # Windows builds
          - goos: windows
            goarch: amd64
            binary: diffusion-windows-amd64.exe
            archive_type: zip
          - goos: windows
            goarch: arm64
            binary: diffusion-windows-arm64.exe
            archive_type: zip
          - goos: windows
            goarch: arm
            goarm: 7
            binary: diffusion-windows-arm.exe
            archive_type: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag is on main branch
        run: |
          git fetch origin main
          if ! git merge-base --is-ancestor ${{ github.sha }} origin/main; then
            echo "Error: Tag must be created from main branch"
            exit 1
          fi

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          mkdir -p bin
          go build -ldflags "-s -w -X main.Version=${{ steps.version.outputs.version }}" -o bin/${{ matrix.binary }} .
          echo "Built: bin/${{ matrix.binary }}"

      - name: Create archive
        run: |
          cd bin
          if [ "${{ matrix.archive_type }}" = "tar.gz" ]; then
            ARCHIVE_NAME="${{ matrix.binary }}.tar.gz"
            tar -czf "$ARCHIVE_NAME" "${{ matrix.binary }}"
            echo "Created: $ARCHIVE_NAME"
          else
            # For Windows, remove .exe from archive name
            BINARY_BASE="${{ matrix.binary }}"
            BINARY_BASE="${BINARY_BASE%.exe}"
            ARCHIVE_NAME="${BINARY_BASE}.zip"
            zip "$ARCHIVE_NAME" "${{ matrix.binary }}"
            echo "Created: $ARCHIVE_NAME"
          fi
          # Remove the binary, keep only the archive
          rm "${{ matrix.binary }}"

      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}-archive
          path: bin/*
          retention-days: 1

  combine-hashes:
    name: Combine artifact hashes
    needs: [build]
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hashes.outputs.hashes }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true

      - name: Generate combined hashes
        id: hashes
        run: |
          cd bin
          # Generate hashes for all archives using find to avoid glob issues
          archives=$(find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) 2>/dev/null)

          if [ -z "$archives" ]; then
            echo "Error: No archive files found"
            exit 1
          fi

          # Generate and encode hashes
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec sha256sum {} \; | base64 -w0 > combined-hashes.txt
          echo "hashes=$(cat combined-hashes.txt)" >> "$GITHUB_OUTPUT"

          echo "Generated hashes:"
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec sha256sum {} \;

  checksums:
    name: Generate Checksums
    needs: [combine-hashes, sign]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd bin
          # Generate checksums for archives
          archives=$(find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) 2>/dev/null)

          if [ -z "$archives" ]; then
            echo "Error: No archive files found"
            exit 1
          fi

          # Generate checksums for all files: archives, signatures, and certificates
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.sig' -o -name '*.pem' \) -exec sha256sum {} \; | tee SHA256SUMS
          echo "Checksums generated:"
          cat SHA256SUMS

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: SHA256SUMS
          path: bin/SHA256SUMS
          retention-days: 1

  sign:
    name: Sign Archives with Cosign
    needs: [combine-hashes]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true

      - name: Sign archives with Cosign (keyless)
        run: |
          cd bin
          # Find all archives using find to avoid glob issues
          archives=$(find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) 2>/dev/null)

          if [ -z "$archives" ]; then
            echo "Error: No archive files found"
            exit 1
          fi

          # Sign all archives
          find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) | while IFS= read -r file; do
            echo "Signing $file..."
            cosign sign-blob --yes "$file" --output-signature "${file}.sig" --output-certificate "${file}.pem"
          done

      - name: Upload signatures
        uses: actions/upload-artifact@v4
        with:
          name: signatures
          path: |
            bin/*.sig
            bin/*.pem
          retention-days: 1

  provenance:
    name: Generate SLSA Provenance
    needs: [combine-hashes]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.combine-hashes.outputs.hashes }}"
      upload-assets: true
      provenance-name: "multiple.intoto.jsonl"

  release:
    name: Create GitHub Release
    needs: [combine-hashes, checksums, sign, provenance]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true

      - name: Create release notes
        id: notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cat > release-notes.md << 'EOF'
          ## Diffusion $VERSION

          ### Installation

          **Windows (Recommended):**
          Install using Chocolatey for automatic updates:
          ```powershell
          choco install diffusion
          ```

          **Manual Installation:**
          Download the appropriate archive for your platform and extract it:

          **Linux:**
          - AMD64: `diffusion-linux-amd64.tar.gz`
          - ARM64: `diffusion-linux-arm64.tar.gz`
          - ARM: `diffusion-linux-arm.tar.gz`

          **macOS:**
          - Intel: `diffusion-darwin-amd64.tar.gz`
          - Apple Silicon: `diffusion-darwin-arm64.tar.gz`

          **Windows:**
          - AMD64: `diffusion-windows-amd64.zip`
          - ARM64: `diffusion-windows-arm64.zip`
          - ARM: `diffusion-windows-arm.zip`

          ### Extraction

          **Linux/macOS:**
          ```bash
          tar -xzf diffusion-linux-amd64.tar.gz
          chmod +x diffusion-linux-amd64
          ```

          **Windows:**
          ```powershell
          Expand-Archive diffusion-windows-amd64.zip
          ```

          ### Verification

          All archives are signed with **Cosign** and have **SLSA Level 3 provenance** for supply chain security.

          **Verify checksums:**
          ```bash
          sha256sum --check SHA256SUMS --ignore-missing
          ```

          **Verify Cosign signature:**
          ```bash
          # Install cosign from https://github.com/sigstore/cosign
          cosign verify-blob \
            --certificate diffusion-linux-amd64.tar.gz.pem \
            --signature diffusion-linux-amd64.tar.gz.sig \
            --certificate-identity-regexp="https://github.com/Polar-Team/diffusion" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            diffusion-linux-amd64.tar.gz
          ```

          **Verify SLSA Provenance:**
          ```bash
          # Install slsa-verifier from https://github.com/slsa-framework/slsa-verifier
          slsa-verifier verify-artifact diffusion-linux-amd64.tar.gz \
            --provenance-path multiple.intoto.jsonl \
            --source-uri github.com/Polar-Team/diffusion \
            --source-tag v$VERSION
          ```

          ### What's Changed

          See [CHANGELOG](https://github.com/Polar-Team/diffusion/blob/main/docs/changelog.md) for details.

          ### Documentation

          - [Installation Guide](https://github.com/Polar-Team/diffusion#-installation)
          - [Building from Source](https://github.com/Polar-Team/diffusion/blob/main/docs/building.md)
          - [Verification Guide](https://github.com/Polar-Team/diffusion/blob/main/docs/verification.md)

          ---

          **Full Changelog**: https://github.com/Polar-Team/diffusion/compare/v$PREVIOUS_VERSION...v$VERSION
          EOF

          sed -i "s/\$VERSION/$VERSION/g" release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/*.tar.gz
            bin/*.zip
            bin/*.sig
            bin/*.pem
            bin/SHA256SUMS
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          {
            echo "## Release Created Successfully! üéâ"
            echo ""
            echo "**Version:** ${GITHUB_REF#refs/tags/v}"
            echo "**Archives:** $(find bin/ -type f \( -name '*.tar.gz' -o -name '*.zip' \) | wc -l)"
            echo "**Signatures:** $(find bin/ -type f -name '*.sig' | wc -l)"
            echo "**Signing:** ‚úì Cosign (keyless)"
            echo "**Provenance:** ‚úì SLSA Level 3 (uploaded separately by provenance job)"
            echo ""
            echo "### Files Released:"
            echo '```'
            find bin/ -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.sig' -o -name '*.pem' -o -name 'SHA256SUMS' \) -exec ls -lh {} \;
            echo '```'
            echo ""
            echo "**Note:** SLSA provenance (multiple.intoto.jsonl) is uploaded directly by the provenance job."
          } >> "$GITHUB_STEP_SUMMARY"

  chocolatey:
    name: Publish to Chocolatey
    needs: [release]
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref }}" -replace '^refs/tags/v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Building Chocolatey package for version: $version"

      - name: Download SHA256SUMS
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $url = "https://github.com/Polar-Team/diffusion/releases/download/v$version/SHA256SUMS"

          Write-Host "Downloading SHA256SUMS from: $url"
          Invoke-WebRequest -Uri $url -OutFile SHA256SUMS

          # Download provenance file to calculate its checksum
          $provenanceUrl = "https://github.com/Polar-Team/diffusion/releases/download/v$version/multiple.intoto.jsonl"
          Write-Host "Downloading provenance file from: $provenanceUrl"
          
          # Retry logic for provenance file (it may take time to be uploaded)
          $maxAttempts = 30
          $downloaded = $false
          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              Invoke-WebRequest -Uri $provenanceUrl -OutFile multiple.intoto.jsonl -ErrorAction Stop
              $downloaded = $true
              Write-Host "Provenance file downloaded successfully"
              break
            } catch {
              Write-Host "Waiting for provenance file to be available... (attempt $i/$maxAttempts)"
              Start-Sleep -Seconds 10
            }
          }

          if ($downloaded) {
            # Calculate and append provenance checksum
            $provenanceHash = (Get-FileHash -Path multiple.intoto.jsonl -Algorithm SHA256).Hash.ToLower()
            Add-Content -Path SHA256SUMS -Value "$provenanceHash  ./multiple.intoto.jsonl"
            Remove-Item multiple.intoto.jsonl
            Write-Host "Added provenance checksum: $provenanceHash"
          } else {
            Write-Warning "Provenance file not available after $maxAttempts attempts"
          }

          # Display checksums for verification
          Write-Host "`nSHA256 Checksums:"
          Get-Content SHA256SUMS

      - name: Update nuspec with version and checksums
        shell: pwsh
        run: |
          # Extract checksums for Windows binaries from SHA256SUMS
          $checksums = Get-Content SHA256SUMS

          # Extract archive checksums
          $amd64Checksum = ($checksums | Select-String "diffusion-windows-amd64.zip" | `
            Where-Object { $_ -notmatch '\.sig|\.pem' } | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)
          $arm64Checksum = ($checksums | Select-String "diffusion-windows-arm64.zip" | `
            Where-Object { $_ -notmatch '\.sig|\.pem' } | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)
          $armChecksum = ($checksums | Select-String "diffusion-windows-arm.zip" | `
            Where-Object { $_ -notmatch '\.sig|\.pem' } | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)

          # Extract signature file checksums
          $amd64SigChecksum = ($checksums | Select-String "diffusion-windows-amd64.zip.sig" | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)
          $arm64SigChecksum = ($checksums | Select-String "diffusion-windows-arm64.zip.sig" | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)
          $armSigChecksum = ($checksums | Select-String "diffusion-windows-arm.zip.sig" | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)

          # Extract certificate file checksums
          $amd64PemChecksum = ($checksums | Select-String "diffusion-windows-amd64.zip.pem" | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)
          $arm64PemChecksum = ($checksums | Select-String "diffusion-windows-arm64.zip.pem" | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)
          $armPemChecksum = ($checksums | Select-String "diffusion-windows-arm.zip.pem" | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)

          # Extract provenance checksum (architecture-independent)
          $provenanceChecksum = ($checksums | Select-String "multiple.intoto.jsonl" | `
            ForEach-Object { $_.Line -split '\s+' } | Select-Object -First 1)

          # Validate that all checksums were extracted
          if (-not $amd64Checksum -or -not $arm64Checksum -or -not $armChecksum) {
            Write-Error "Failed to extract all required archive checksums from SHA256SUMS"
            Write-Host "SHA256SUMS content:"
            Get-Content SHA256SUMS
            exit 1
          }

          if (-not $amd64SigChecksum -or -not $arm64SigChecksum -or -not $armSigChecksum) {
            Write-Error "Failed to extract all required signature checksums from SHA256SUMS"
            Write-Host "SHA256SUMS content:"
            Get-Content SHA256SUMS
            exit 1
          }

          if (-not $amd64PemChecksum -or -not $arm64PemChecksum -or -not $armPemChecksum) {
            Write-Error "Failed to extract all required certificate checksums from SHA256SUMS"
            Write-Host "SHA256SUMS content:"
            Get-Content SHA256SUMS
            exit 1
          }

          if (-not $provenanceChecksum) {
            Write-Error "Provenance checksum not found in SHA256SUMS - this is required for Chocolatey publishing"
            Write-Host "SHA256SUMS content:"
            Get-Content SHA256SUMS
            exit 1
          }

          Write-Host "Extracted Archive Checksums:"
          Write-Host "AMD64: $amd64Checksum"
          Write-Host "ARM64: $arm64Checksum"
          Write-Host "ARM: $armChecksum"
          Write-Host ""
          Write-Host "Extracted Signature Checksums:"
          Write-Host "AMD64: $amd64SigChecksum"
          Write-Host "ARM64: $arm64SigChecksum"
          Write-Host "ARM: $armSigChecksum"
          Write-Host ""
          Write-Host "Extracted Certificate Checksums:"
          Write-Host "AMD64: $amd64PemChecksum"
          Write-Host "ARM64: $arm64PemChecksum"
          Write-Host "ARM: $armPemChecksum"
          Write-Host ""
          Write-Host "Extracted Provenance Checksum: $provenanceChecksum"

          # Run the update script
          .\.github\scripts\update-chocolatey.ps1 `
            -Version "${{ steps.version.outputs.version }}" `
            -Amd64Checksum "$amd64Checksum" `
            -Arm64Checksum "$arm64Checksum" `
            -ArmChecksum "$armChecksum" `
            -Amd64SigChecksum "$amd64SigChecksum" `
            -Arm64SigChecksum "$arm64SigChecksum" `
            -ArmSigChecksum "$armSigChecksum" `
            -Amd64PemChecksum "$amd64PemChecksum" `
            -Arm64PemChecksum "$arm64PemChecksum" `
            -ArmPemChecksum "$armPemChecksum" `
            -ProvenanceChecksum "$provenanceChecksum"

      - name: Install Chocolatey
        shell: pwsh
        run: |
          # Chocolatey should be pre-installed on GitHub-hosted Windows runners
          # This step ensures it's available and updated
          if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "Installing Chocolatey..."
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          } else {
            Write-Host "Chocolatey is already installed"
            choco --version
          }

      - name: Build Chocolatey package
        shell: pwsh
        run: |
          choco pack chocolatey/diffusion.nuspec --outputdirectory .

          # Verify the package was created
          $nupkg = Get-ChildItem -Filter "diffusion.*.nupkg" | Select-Object -First 1
          if ($nupkg) {
            Write-Host "Successfully created package: $($nupkg.Name)"
          } else {
            throw "Failed to create Chocolatey package"
          }

      - name: Publish to Chocolatey
        shell: pwsh
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          $nupkg = Get-ChildItem -Filter "diffusion.*.nupkg" | Select-Object -First 1

          if ($env:CHOCOLATEY_API_KEY) {
            Write-Host "Publishing $($nupkg.Name) to Chocolatey..."
            choco push $nupkg.FullName --source https://push.chocolatey.org/ --api-key $env:CHOCOLATEY_API_KEY
            Write-Host "Successfully published to Chocolatey!"
          } else {
            Write-Host "CHOCOLATEY_API_KEY not set - skipping publish"
            Write-Host "Package built successfully but not published: $($nupkg.Name)"
          }

      - name: Summary
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $nupkg = Get-ChildItem -Filter "diffusion.*.nupkg" | Select-Object -First 1

          $summary = @"
          ## Chocolatey Package Published! üç´

          **Version:** $version
          **Package:** $($nupkg.Name)
          **Install Command:**
          ``````powershell
          choco install diffusion
          ``````

          **Note:** It may take a few minutes for the package to appear on chocolatey.org while it goes through automated verification.
          "@

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
